<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Math Quiz ‚Ä¢ Black & Gold</title>

<!-- Theme: Black & Gold, calm animations, vanilla JS (no jQuery), Canva-safe -->
<style>
  :root{
    --bg:#0b0b0f;
    --panel:#12121a;
    --gold:#d4af37;
    --muted:#a6a6b3;
    --ok:#38c172;
    --bad:#e3342f;
    --accent:#8a6b1f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    color:#eee;
    background:
      radial-gradient(1200px 600px at 80% -10%, #201a10 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 10%, #15121a 0%, transparent 60%),
      var(--bg);
  }
  h1,h2,h3{margin:0 0 8px}
  a,button,input,select,textarea{font:inherit}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  .brand{
    display:flex;align-items:center;gap:12px;margin-bottom:20px
  }
  .logo{
    width:40px;height:40px;border-radius:10px;
    background:linear-gradient(135deg,var(--gold),#ffefb0);
    box-shadow:0 0 0 2px #0004, 0 6px 20px #0007;
  }
  .title{font-weight:700;letter-spacing:.5px}
  .gold{color:var(--gold)}
  .muted{color:var(--muted)}
  .panel{
    background:linear-gradient(180deg,#12121a, #0f0f14);
    border:1px solid #22222e;
    border-radius:16px;
    padding:20px;
    box-shadow:0 12px 40px #0008 inset, 0 2px 0 #ffffff08;
  }
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:800px){.two{grid-template-columns:1fr}}

  .btn{
    background:linear-gradient(180deg,#1b1b25,#14141c);
    border:1px solid #2a2a35;
    color:#eee;padding:12px 16px;border-radius:12px;
    cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px
  }
  .btn:hover{transform:translateY(-1px);border-color:#3a3a48}
  .btn.gold{background:linear-gradient(180deg,#2b230f,#1b160a);border-color:#4a3b14;color:#fff}
  .btn.ghost{background:transparent;border:1px dashed #2a2a35;color:#bbb}
  .btn.block{width:100%;justify-content:center}

  .input,select,textarea{
    width:100%;padding:12px 14px;border-radius:10px;background:#0e0e15;
    border:1px solid #2a2a35;color:#eee;outline:none
  }
  .input:focus,select:focus,textarea:focus{border-color:#3a3a48;box-shadow:0 0 0 4px #ffffff06}

  .bar{height:10px;border-radius:999px;background:#1a1a22;border:1px solid #292936}
  .bar>span{display:block;height:8px;margin:0 1px;border-radius:999px;background:linear-gradient(90deg,#3f3210,var(--gold))}
  .tags{display:flex;gap:8px;flex-wrap:wrap}
  .tag{padding:6px 10px;border-radius:999px;background:#0e0e15;border:1px solid #2a2a35;color:#bbb}

  .page{display:none}
  .page.active{display:block}

  .qcard{
    padding:16px;border-radius:14px;background:#0e0e15;border:1px solid #242434
  }
  .opt{
    display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:10px;
    background:#0b0b12;border:1px solid #222236;cursor:pointer
  }
  .opt:hover{border-color:#32324a}
  .opt input{margin-top:3px}
  .opt.correct{border-color:#2b6b3b;background:#0e1411}
  .opt.wrong{border-color:#7a2b2b;background:#141010}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{flex:1 min(180px);padding:14px;border-radius:12px;background:#0e0e15;border:1px solid #242434}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid #242434;text-align:left}
  .table th{color:#bbb;font-weight:600}
  .pill{padding:4px 10px;border-radius:999px;background:#0e0e15;border:1px solid #2a2a35}

  .float-math{
    position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.25
  }
  .bit{
    position:absolute;color:var(--gold);font-weight:700;filter:drop-shadow(0 0 6px #000);
    animation:float 14s linear infinite;
  }
  @keyframes float{
    from{transform:translateY(110vh) rotate(0deg);opacity:.0}
    10%{opacity:.9}
    90%{opacity:.9}
    to{transform:translateY(-20vh) rotate(360deg);opacity:0}
  }

  .podium{display:flex;gap:12px;align-items:flex-end}
  .pod{flex:1;background:#0e0e15;border:1px solid #242434;border-radius:12px;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;height:140px;padding:8px}
  .pod:nth-child(1){height:180px;border-color:#5a4818}
  .pod h4{margin:6px 0 0}

  .cert{
    width:min(900px,100%);margin:0 auto;background:white;color:#111;padding:36px;border:10px solid #d4af37;border-radius:14px;
    box-shadow:0 20px 60px #0009
  }
  .cert h1{color:#8a6b1f}
  .cert .sig{display:flex;justify-content:space-between;margin-top:32px;color:#333}
</style>
</head>
<body>

<div class="float-math" id="mathField"></div>

<div class="wrap">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <div class="title">Mathematics Quiz <span class="gold">‚Ä¢ Black & Gold</span></div>
      <div class="muted">Slow & classy ‚Ä¢ silent animations</div>
    </div>
  </div>

  <!-- PAGE 1: Registration -->
  <section id="page-start" class="page active">
    <div class="panel grid">
      <h2 class="gold">Start</h2>
      <div class="grid two">
        <div class="grid">
          <label>Full Name</label>
          <input id="stuName" class="input" placeholder="Your full name" />
        </div>
        <div class="grid">
          <label>Matric Number</label>
          <input id="stuMatric" class="input" placeholder="e.g. MKT12345" />
        </div>
        <div class="grid">
          <label>Class</label>
          <select id="stuClass" class="input">
            <option value="">Choose class</option>
            <option>H3D</option>
            <option>F1D</option>
            <option>H2D</option>
          </select>
        </div>
        <div class="grid">
          <label>Ready?</label>
          <button id="btnStart" class="btn gold">Start Quiz</button>
        </div>
      </div>
      <div class="tags">
        <span class="tag">Data saved locally</span>
        <span class="tag">Random order</span>
        <span class="tag">Timer & leaderboard</span>
      </div>
    </div>
  </section>

  <!-- PAGE 2: Quiz -->
  <section id="page-quiz" class="page">
    <div class="panel grid">
      <div class="grid two">
        <div>
          <h2>Question <span id="qNum">1</span>/<span id="qTotal">10</span></h2>
          <div class="muted">Class: <span id="hdrClass"></span> ‚Ä¢ Name: <span id="hdrName"></span> ‚Ä¢ Matric: <span id="hdrMatric"></span></div>
        </div>
        <div>
          <div class="muted" style="text-align:right">Time <span id="timeLive" class="pill mono">00:00</span></div>
          <div class="bar"><span id="progress" style="width:0%"></span></div>
        </div>
      </div>

      <div id="qContainer" class="qcard"></div>

      <div class="grid two">
        <button id="btnPrev" class="btn ghost">Back</button>
        <button id="btnNext" class="btn gold">Next</button>
      </div>
    </div>
  </section>

  <!-- PAGE 3: Student Dashboard -->
  <section id="page-student" class="page">
    <div class="panel grid">
      <h2 class="gold">Student Dashboard</h2>
      <div class="kpi">
        <div class="box"><div class="muted">Score</div><div id="kpiScore" class="mono" style="font-size:22px">‚Äì</div></div>
        <div class="box"><div class="muted">Percentage</div><div id="kpiPct" class="mono" style="font-size:22px">‚Äì</div></div>
        <div class="box"><div class="muted">Time</div><div id="kpiTime" class="mono" style="font-size:22px">‚Äì</div></div>
        <div class="box"><div class="muted">Rank</div><div id="kpiRank" class="mono" style="font-size:22px">‚Äì</div></div>
      </div>

      <div id="tips" class="qcard"></div>

      <h3>Answer Review</h3>
      <div id="review"></div>

      <div class="grid two">
        <button id="btnToLeaderboard" class="btn">Go to Leaderboard</button>
        <button id="btnToCert" class="btn gold">Generate Certificate</button>
      </div>
    </div>
  </section>

  <!-- PAGE 4: Leaderboard -->
  <section id="page-leader" class="page">
    <div class="panel grid">
      <h2 class="gold">Leaderboard</h2>
      <div class="podium">
        <div class="pod" id="p2"><div class="muted">ü•à</div><h4 id="p2n">‚Äì</h4><div id="p2s" class="muted mono">‚Äì</div></div>
        <div class="pod" id="p1"><div class="muted">ü•á</div><h4 id="p1n">‚Äì</h4><div id="p1s" class="muted mono">‚Äì</div></div>
        <div class="pod" id="p3"><div class="muted">ü•â</div><h4 id="p3n">‚Äì</h4><div id="p3s" class="muted mono">‚Äì</div></div>
      </div>
      <div class="qcard muted">Top 3 winners please collect hadiah from Miss Anis üéÅ</div>

      <div class="grid two">
        <div class="grid">
          <label>Filter by Class</label>
          <select id="filterClass" class="input">
            <option value="">All</option>
            <option>H3D</option>
            <option>F1D</option>
            <option>H2D</option>
          </select>
        </div>
        <div style="align-self:end;text-align:right">
          <button id="btnMyDash" class="btn">My Dashboard</button>
        </div>
      </div>

      <table class="table" id="tblLead">
        <thead><tr><th>#</th><th>Name</th><th>Class</th><th>Matric</th><th>Score</th><th>%</th><th>Time(s)</th><th>Date</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- PAGE 5: Certificate -->
  <section id="page-cert" class="page">
    <div class="panel grid">
      <h2 class="gold">Certificate</h2>
      <div id="certBox" class="cert">
        <h1>Certificate of Achievement</h1>
        <p>This is awarded to</p>
        <h2 id="cName"></h2>
        <p>for outstanding performance in</p>
        <h3>Mathematics Quiz</h3>
        <div class="grid two" style="margin-top:10px">
          <div>Score: <b id="cScore"></b></div>
          <div>Time: <b id="cTime"></b></div>
        </div>
        <div>Date: <span id="cDate"></span></div>
        <div class="sig">
          <div>___________________<br/>Miss Anis</div>
          <div>___________________<br/>Teacher</div>
        </div>
      </div>
      <div class="grid two">
        <button id="btnBackDash" class="btn">Back to Dashboard</button>
        <button id="btnSaveCert" class="btn gold">Download PNG</button>
      </div>
    </div>
  </section>

  <!-- PAGE 6: Teacher Admin -->
  <section id="page-admin" class="page">
    <div class="panel grid">
      <h2 class="gold">Teacher Admin</h2>
      <div id="gate" class="grid two">
        <input id="adminPass" class="input" type="password" placeholder="Enter password" />
        <button id="btnAdminLogin" class="btn gold">Login</button>
      </div>

      <div id="adminBody" style="display:none">
        <div class="grid two">
          <div class="grid">
            <label>Filter by Class</label>
            <select id="adminClass" class="input">
              <option value="">All</option>
              <option>H3D</option>
              <option>F1D</option>
              <option>H2D</option>
            </select>
          </div>
          <div class="grid" style="justify-items:end">
            <button id="btnExport" class="btn">Export CSV</button>
            <button id="btnClear" class="btn" style="border-color:#7a2b2b;color:#f3baba">Clear All Results</button>
          </div>
        </div>

        <table class="table" id="tblAdmin">
          <thead><tr><th>#</th><th>Name</th><th>Class</th><th>Matric</th><th>Score</th><th>%</th><th>Time(s)</th><th>Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="panel" style="margin-top:16px">
    <div class="tags">
      <button class="btn" id="navStart">Start</button>
      <button class="btn" id="navQuiz">Quiz</button>
      <button class="btn" id="navStudent">Student</button>
      <button class="btn" id="navLeader">Leaderboard</button>
      <button class="btn" id="navCert">Certificate</button>
      <button class="btn" id="navAdmin">Teacher</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" referrerpolicy="no-referrer"></script>
<script>
/* ====== Storage helpers (localStorage, safe JSON) ====== */
function getStore(key, fallback){
  try{const s=localStorage.getItem(key);return s?JSON.parse(s):fallback}catch(e){return fallback}
}
function setStore(key, val){
  try{localStorage.setItem(key, JSON.stringify(val))}catch(e){}
}

/* ====== Pages controller ====== */
const pages=['page-start','page-quiz','page-student','page-leader','page-cert','page-admin'];
function showPage(id){
  pages.forEach(pid=>{
    const el=document.getElementById(pid);
    if(!el) return;
    el.classList.toggle('active', pid===id);
  });
}

/* ====== Math floaters (silent, slow) ====== */
(function initFloaters(){
  const field=document.getElementById('mathField');
  if(!field) return;
  const glyphs=['œÄ','‚àö','‚àë','|x|','‚àû','‚à´','‚àÜ','‚âà','‚â•','‚â§'];
  function spawn(){
    const s=document.createElement('div');
    s.className='bit';
    s.textContent=glyphs[Math.floor(Math.random()*glyphs.length)];
    s.style.left=Math.round(Math.random()*100)+'vw';
    s.style.fontSize=(Math.random()*24+16)+'px';
    s.style.animationDuration=(Math.random()*10+12)+'s';
    field.appendChild(s);
    setTimeout(()=>s.remove(),15000);
  }
  for(let i=0;i<16;i++) setTimeout(spawn, i*600);
  setInterval(spawn, 1800);
})();

/* ====== Question bank (user-provided) ====== */
/* Q1 subjective with five subparts; others MCQ with solutions and step-by-step */
const QUESTION_BANK = [
  {
    id:'Q1',
    type:'subjective',
    prompt:'State the terminology for the following descriptions:',
    parts:[
      { key:'a', text:'The values resulting in an equation or inequality to be true.', answer:['solution','solutions'] },
      { key:'b', text:'The term ax¬≤ in the quadratic expression ax¬≤ + bx + c.', answer:['quadratic term'] },
      { key:'c', text:'The multiplicative factor of x in linear or quadratic expression.', answer:['linear coefficient','coefficient of x','coefficient'] },
      { key:'d', text:'The values resulting in an expression to evaluate to zero.', answer:['zeroes','zeros','roots'] },
      { key:'e', text:'The other terminology for absolute value of x.', answer:['modulus'] },
    ],
    solutionSteps:
      'a) Solution\nb) Quadratic term\nc) Linear coefficient\nd) Zeroes (of the expression)\ne) Modulus'
  },
  {
    id:'Q2',
    type:'mcq',
    prompt:'Solve: ‚àö(2x + 3) + ‚àö(x ‚àí 2) = 4',
    options:[
      {k:'a',t:'x = 83'},{k:'b',t:'x = 4'},{k:'c',t:'x = 3'},{k:'d',t:'x = 2'}
    ],
    correct:'c',
    solutionSteps:'Isolate and square carefully. Check extraneous roots: valid solution is x=3.'
  },
  {
    id:'Q3',
    type:'mcq',
    prompt:'Evaluate (x¬≤ + 3x + 2)/(x + 1) ‚â• 0',
    options:[
      {k:'a',t:'(-‚àû, -1) ‚à™ (-1, ‚àû)'},
      {k:'b',t:'[-2, -1) ‚à™ (-1, ‚àû)'},
      {k:'c',t:'(-‚àû, -2] ‚à™ (-1, ‚àû)'},
      {k:'d',t:'[-2, ‚àû)'}
    ],
    correct:'b',
    solutionSteps:'Critical points at x=-2 and x=-1 (excluded). Sign chart ‚Üí [-2,-1) ‚à™ (-1,‚àû).'
  },
  {
    id:'Q4',
    type:'mcq',
    prompt:'Find range: (3x + 2)(2x + 5) < 0',
    options:[
      {k:'a',t:'(-‚àû, -5/2)'},
      {k:'b',t:'(-5/2, -2/3)'},
      {k:'c',t:'(-2/3, ‚àû)'},
      {k:'d',t:'(-‚àû, -2/3)'}
    ],
    correct:'b',
    solutionSteps:'Roots at -5/2 and -2/3. Negative between roots ‚Üí (-5/2, -2/3).'
  },
  {
    id:'Q5',
    type:'mcq',
    prompt:'Solve: ((x + 2)(x - 1))/(x + 1) < 0',
    options:[
      {k:'a',t:'(-‚àû, -2) ‚à™ (-1, 1)'},
      {k:'b',t:'(-‚àû, -1) ‚à™ (1, ‚àû)'},
      {k:'c',t:'(-2, -1) ‚à™ (1, ‚àû)'},
      {k:'d',t:'(-‚àû, 1)'}
    ],
    correct:'a',
    solutionSteps:'Critical points -2,-1,1. Sign chart ‚Üí (-‚àû,-2) ‚à™ (-1,1).'
  },
  {
    id:'Q6a',
    type:'mcq',
    prompt:'Solve: (2x ‚àí 1)/(x ‚àí 1) > 1',
    options:[
      {k:'a',t:'(0, 1)'},
      {k:'b',t:'(-‚àû, 0) ‚à™ (1, ‚àû)'},
      {k:'c',t:'(0, ‚àû)'},
      {k:'d',t:'(1, ‚àû)'}
    ],
    correct:'b',
    solutionSteps:'Bring to one side, consider domain x‚â†1. Solution ‚Üí (-‚àû,0) ‚à™ (1,‚àû).'
  },
  {
    id:'Q6b',
    type:'mcq',
    prompt:'Solve: (x¬≤ ‚àí 3x + 2)/(x ‚àí 3) ‚â• 0',
    options:[
      {k:'a',t:'(-‚àû, 1] ‚à™ [2, 3)'},
      {k:'b',t:'[1, 2] ‚à™ (3, ‚àû)'},
      {k:'c',t:'(1, 2) ‚à™ (3, ‚àû)'},
      {k:'d',t:'[1, 3)'}
    ],
    correct:'b',
    solutionSteps:'Factor numerator (x‚àí1)(x‚àí2). Consider x=3 excluded. Nonnegative on [1,2] ‚à™ (3,‚àû).'
  },
  {
    id:'Q7',
    type:'mcq',
    prompt:'Solve: |5x + 7| > |4x ‚àí 6|',
    options:[
      {k:'a',t:'(-‚àû, -13) ‚à™ (-1, 9)'},
      {k:'b',t:'(-‚àû, -13) ‚à™ (-1/9, ‚àû)'},
      {k:'c',t:'(-13, -1/9)'},
      {k:'d',t:'(-1/9, 13)'}
    ],
    correct:'b',
    solutionSteps:'Square both sides or compare distances; solution (-‚àû, -13) ‚à™ (-1/9, ‚àû).'
  },
  {
    id:'Q8',
    type:'mcq',
    prompt:'Solve: |3x + 4| ‚â• |x + 2|',
    options:[
      {k:'a',t:'(-‚àû, -1] ‚à™ [2, ‚àû)'},
      {k:'b',t:'(-‚àû, -3/2] ‚à™ [-1, ‚àû)'},
      {k:'c',t:'[-1, ‚àû)'},
      {k:'d',t:'(-‚àû, -3/2)'}
    ],
    correct:'b',
    solutionSteps:'Square and simplify: 9x¬≤+24x+16 ‚â• x¬≤+4x+4 ‚Üí 8x¬≤+20x+12 ‚â• 0 ‚Üí intervals yield result.'
  },
  {
    id:'Q9',
    type:'mcq',
    prompt:'Solve: |(x + 3)/x| > 1',
    options:[
      {k:'a',t:'(-‚àû, -3/2) ‚à™ (0, ‚àû)'},
      {k:'b',t:'(-3/2, 0) ‚à™ (0, ‚àû)'},
      {k:'c',t:'(-‚àû, 0)'},
      {k:'d',t:'(0, ‚àû)'}
    ],
    correct:'b',
    solutionSteps:'Casework on x>0 and x<0; exclude x=0. Result (-3/2,0) ‚à™ (0,‚àû).'
  },
  {
    id:'Q10',
    type:'mcq',
    prompt:'Solve: 2x¬≤ ‚àí 3x ‚àí 4 = 0',
    options:[
      {k:'a',t:'x = (3 ¬± ‚àö41)/2'},
      {k:'b',t:'x = (-3 ¬± ‚àö41)/4'},
      {k:'c',t:'x = (3 ¬± ‚àö41)/4'},
      {k:'d',t:'x = (3 ¬± ‚àö41)/8'}
    ],
    correct:'c',
    solutionSteps:'Quadratic formula: x = [3 ¬± ‚àö(9+32)]/(2¬∑2) = (3 ¬± ‚àö41)/4.'
  }
];

/* ====== Runtime quiz state ====== */
let quiz = {
  student:null,            // {name,matric,klass}
  list:[],                 // randomized questions
  idx:0,                   // current index
  answers:[],              // per-question or per-part answers
  startedAt:0,             // ms timestamp
  finishedAt:0,            // ms timestamp
  timerId:null             // live timer interval
};

/* ====== Utility formatting ====== */
function mmss(sec){
  const s = Math.max(0, Math.floor(sec));
  const m = Math.floor(s/60);
  const r = s%60;
  return (m<10?'0':'')+m+':'+(r<10?'0':'')+r;
}

/* ====== Start flow ====== */
document.getElementById('btnStart').addEventListener('click', ()=>{
  const name=document.getElementById('stuName').value.trim();
  const matric=document.getElementById('stuMatric').value.trim();
  const klass=document.getElementById('stuClass').value.trim();
  if(!name||!matric||!klass){alert('Please fill name, matric and class.');return;}
  quiz.student={name,matric,klass};
  quiz.list = [...QUESTION_BANK].sort(()=>Math.random()-0.5);
  quiz.idx=0; quiz.answers=[]; quiz.startedAt=Date.now(); quiz.finishedAt=0;
  document.getElementById('hdrName').textContent=name;
  document.getElementById('hdrMatric').textContent=matric;
  document.getElementById('hdrClass').textContent=klass;
  document.getElementById('qTotal').textContent=quiz.list.length;
  showPage('page-quiz');
  renderQuestion();
  startLiveTimer();
});

/* ====== Live timer ====== */
function startLiveTimer(){
  const el=document.getElementById('timeLive');
  if(quiz.timerId) clearInterval(quiz.timerId);
  quiz.timerId=setInterval(()=>{
    const sec=(Date.now()-quiz.startedAt)/1000;
    el.textContent=mmss(sec);
  },500);
}
function stopLiveTimer(){
  if(quiz.timerId){clearInterval(quiz.timerId);quiz.timerId=null;}
}

/* ====== Render current question ====== */
function renderQuestion(){
  const q=quiz.list[quiz.idx];
  const cont=document.getElementById('qContainer');
  document.getElementById('qNum').textContent=quiz.idx+1;
  const pct=((quiz.idx)/quiz.list.length)*100;
  document.getElementById('progress').style.width=pct.toFixed(1)+'%';

  if(q.type==='subjective'){
    const prior = quiz.answers.find(a=>a.id===q.id);
    const val = prior && prior.parts ? prior.parts : {a:'',b:'',c:'',d:'',e:''};
    cont.innerHTML = `
      <div style="margin-bottom:8px">${q.prompt}</div>
      <div class="grid">
        ${q.parts.map(p=>`
          <div class="grid">
            <label><b>(${p.key})</b> ${p.text}</label>
            <input class="input" data-part="${p.key}" placeholder="Type your answer..." value="${(val[p.key]||'').replace(/"/g,'&quot;')}" />
          </div>
        `).join('')}
      </div>
    `;
  }else{
    const prior = quiz.answers.find(a=>a.id===q.id);
    const chosen = prior ? prior.choice : null;
    cont.innerHTML = `
      <div style="margin-bottom:8px">${q.prompt}</div>
      <div class="grid">
        ${q.options.map(o=>`
          <label class="opt">
            <input type="radio" name="mcq" value="${o.k}" ${chosen===o.k?'checked':''} />
            <div><b>(${o.k})</b> ${o.t}</div>
          </label>
        `).join('')}
      </div>
    `;
  }

  document.getElementById('btnPrev').disabled = quiz.idx===0;
  document.getElementById('btnNext').textContent = (quiz.idx===quiz.list.length-1)?'Submit Quiz':'Next';
}

/* ====== Capture current answer (without advancing) ====== */
function captureAnswer(){
  const q=quiz.list[quiz.idx];
  let rec = quiz.answers.find(a=>a.id===q.id);
  if(!rec){rec={id:q.id}; quiz.answers.push(rec);}
  if(q.type==='subjective'){
    const inputs=[...document.querySelectorAll('#qContainer input[data-part]')];
    const parts={};
    inputs.forEach(inp=>{parts[inp.dataset.part]=inp.value.trim()});
    rec.parts=parts;
  }else{
    const pick=document.querySelector('input[name="mcq"]:checked');
    rec.choice = pick? pick.value : null;
  }
}

/* ====== Nav buttons ====== */
document.getElementById('btnPrev').addEventListener('click', ()=>{
  captureAnswer();
  if(quiz.idx>0){quiz.idx--; renderQuestion();}
});

document.getElementById('btnNext').addEventListener('click', ()=>{
  captureAnswer();
  if(quiz.idx===quiz.list.length-1){
    endQuiz();          // Submit on last question
  }else{
    quiz.idx++; renderQuestion();
  }
});

/* ====== Scoring ====== */
function scoreNow(){
  let score=0, total=quiz.list.length;
  const detail = quiz.list.map(q=>{
    if(q.type==='subjective'){
      const rec = quiz.answers.find(a=>a.id===q.id);
      const parts = (rec && rec.parts) ? rec.parts : {};
      const checks = q.parts.map(p=>{
        const ans=(parts[p.key]||'').toLowerCase().trim();
        const ok = p.answer.some(acc => ans===acc.toLowerCase());
        return {key:p.key, given:parts[p.key]||'', correct:ok, expect:p.answer[0]};
      });
      const partScore = checks.every(c=>c.correct) ? 1 : 0;
      score += partScore;
      return {id:q.id, type:q.type, correct:partScore===1, parts:checks, solution:q.solutionSteps};
    }else{
      const rec = quiz.answers.find(a=>a.id===q.id);
      const chosen = rec? rec.choice : null;
      const ok = chosen===q.correct;
      if(ok) score+=1;
      const chosenText = q.options.find(o=>o.k===chosen)?.t || '';
      const correctText = q.options.find(o=>o.k===q.correct)?.t || '';
      return {id:q.id, type:q.type, correct:ok, chosen, chosenText, correctKey:q.correct, correctText, solution:q.solutionSteps};
    }
  });

  const finishedAt = quiz.finishedAt || Date.now();
  const timeSec = Math.max(1, Math.round((finishedAt - quiz.startedAt)/1000));
  const pct = Math.round((score/total)*100);

  return {score,total,pct,timeSec,detail};
}

/* ====== Persist and ranking ====== */
function saveAttempt(result){
  const all=getStore('quizResults',[]);
  const rec={
    name:quiz.student.name,
    klass:quiz.student.klass,
    matric:quiz.student.matric,
    score:result.score,
    total:result.total,
    pct:result.pct,
    time:result.timeSec,
    detail:result.detail,
    ts:new Date().toISOString()
  };
  all.push(rec);
  setStore('quizResults',all);
  setStore('lastAttempt',rec);
  return rec;
}
function rankAll(filterClass){
  const all=getStore('quizResults',[]);
  const list = filterClass? all.filter(r=>r.klass===filterClass): all.slice();
  list.sort((a,b)=>{
    if(b.score!==a.score) return b.score-a.score;
    return a.time-b.time;
  });
  return list;
}

/* ====== End quiz ====== */
function endQuiz(){
  quiz.finishedAt=Date.now();
  stopLiveTimer();
  const result = scoreNow();
  const saved = saveAttempt(result);
  buildStudentDashboard(saved);
  buildLeaderboard();
  showPage('page-student');
}

/* ====== Student dashboard build ====== */
function buildStudentDashboard(my){
  const all = rankAll();
  const idx = all.findIndex(r=>r.name===my.name && r.matric===my.matric && r.ts===my.ts);
  const rank = idx>=0? (idx+1) : '-';
  document.getElementById('kpiScore').textContent = `${my.score}/${my.total}`;
  document.getElementById('kpiPct').textContent = `${my.pct}%`;
  document.getElementById('kpiTime').textContent = `${my.time}s`;
  document.getElementById('kpiRank').textContent = `${rank}`;

  const tipsEl=document.getElementById('tips');
  let tip = 'Great effort. Review the step-by-step solutions below.';
  if(my.pct>=90) tip='Outstanding! Keep challenging yourself with harder problems.';
  else if(my.pct>=70) tip='Good job! Strengthen topics you missed to push above 90%.';
  else if(my.pct>=50) tip='You‚Äôre close. Revisit fundamentals and practice similar items.';
  else tip='Start with basics: factoring, absolute value, and sign charts.';
  tipsEl.textContent = tip;

  const review=document.getElementById('review');
  review.innerHTML='';
  my.detail.forEach((d,i)=>{
    const box=document.createElement('div');
    box.className='qcard';
    if(d.type==='subjective'){
      const rows = d.parts.map(p=>`
        <tr><td>(${p.key})</td><td class="mono">${p.given||'‚Äî'}</td><td>${p.correct?'‚úÖ':'‚ùå'}</td><td class="mono">${p.expect}</td></tr>
      `).join('');
      box.innerHTML = `
        <div><b>Q${i+1} ‚Ä¢ Subjective</b> ${d.correct?'‚úÖ':'‚ùå'}</div>
        <table class="table"><thead><tr><th>Part</th><th>Your Answer</th><th></th><th>Expected</th></tr></thead><tbody>${rows}</tbody></table>
        <div class="muted" style="margin-top:8px;white-space:pre-line">${d.solution.replace(/\n/g,'\n')}</div>
      `;
    }else{
      box.innerHTML = `
        <div><b>Q${i+1}</b> ${d.correct?'‚úÖ':'‚ùå'}</div>
        <div class="grid two">
          <div>Your Answer: <span class="${d.correct?'':'muted'}">(${d.chosen||'‚Äî'}) ${d.chosenText||''}</span></div>
          <div>Correct: <span class="gold">(${d.correctKey}) ${d.correctText}</span></div>
        </div>
        <div class="muted" style="margin-top:8px">${d.solution}</div>
      `;
    }
    review.appendChild(box);
  });
}

/* ====== Leaderboard build ====== */
function fillPodium(list){
  const slots=[{n:'p1n',s:'p1s'},{n:'p2n',s:'p2s'},{n:'p3n',s:'p3s'}];
  for(let i=0;i<3;i++){
    const r=list[i];
    const nn=document.getElementById(slots[i].n);
    const ss=document.getElementById(slots[i].s);
    if(r){ nn.textContent=r.name; ss.textContent=`${r.score}/${r.total} ‚Ä¢ ${r.time}s`; }
    else { nn.textContent='‚Äì'; ss.textContent='‚Äì'; }
  }
}
function buildLeaderboard(){
  const sel=document.getElementById('filterClass');
  const list=rankAll(sel.value||'');
  fillPodium(list);
  const tb=document.querySelector('#tblLead tbody');
  tb.innerHTML='';
  list.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${r.klass}</td>
      <td>${r.matric}</td>
      <td>${r.score}/${r.total}</td>
      <td>${r.pct}%</td>
      <td>${r.time}</td>
      <td>${new Date(r.ts).toLocaleString()}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ====== Certificate build ====== */
function buildCert(){
  const last=getStore('lastAttempt',null);
  if(!last){alert('No attempt found. Complete a quiz first.'); return;}
  document.getElementById('cName').textContent=last.name;
  document.getElementById('cScore').textContent=`${last.score}/${last.total} (${last.pct}%)`;
  document.getElementById('cTime').textContent=`${last.time}s`;
  document.getElementById('cDate').textContent=new Date(last.ts).toLocaleDateString();
}

/* ====== Teacher admin ====== */
const ADMIN_SECRET="Anis120467//";
document.getElementById('btnAdminLogin').addEventListener('click', ()=>{
  const v=document.getElementById('adminPass').value;
  if(v===ADMIN_SECRET){
    document.getElementById('gate').style.display='none';
    document.getElementById('adminBody').style.display='block';
    buildAdminTable();
  }else{
    alert('Wrong password');
  }
});
function buildAdminTable(){
  const klass=document.getElementById('adminClass').value||'';
  const list=rankAll(klass);
  const tb=document.querySelector('#tblAdmin tbody');
  tb.innerHTML='';
  list.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td><td>${r.name}</td><td>${r.klass}</td><td>${r.matric}</td>
      <td>${r.score}/${r.total}</td><td>${r.pct}%</td><td>${r.time}</td><td>${new Date(r.ts).toLocaleString()}</td>
    `;
    tb.appendChild(tr);
  });
}
document.getElementById('adminClass').addEventListener('change', buildAdminTable);
document.getElementById('btnClear').addEventListener('click', ()=>{
  if(!confirm('Clear all saved results?')) return;
  setStore('quizResults',[]);
  setStore('lastAttempt',null);
  buildAdminTable();
  buildLeaderboard();
});
document.getElementById('btnExport').addEventListener('click', ()=>{
  const all=getStore('quizResults',[]);
  const header=['Name','Class','Matric','Score','Total','Percent','Time(s)','ISO Date'];
  const rows = all.map(r=>[
    r.name,r.klass,r.matric,r.score,r.total,r.pct,r.time,r.ts
  ]);
  const csv = [header].concat(rows).map(line=>{
    return line.map(cell=>{
      const s=String(cell??'');
      return `"${s.replace(/"/g,'""')}"`;
    }).join(',');
  }).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='results.csv';a.click();
  URL.revokeObjectURL(url);
});

/* ====== Nav buttons ====== */
document.getElementById('navStart').addEventListener('click', ()=>showPage('page-start'));
document.getElementById('navQuiz').addEventListener('click', ()=>showPage('page-quiz'));
document.getElementById('navStudent').addEventListener('click', ()=>{
  const last=getStore('lastAttempt',null);
  if(!last){alert('No attempt yet.');return;}
  buildStudentDashboard(last);
  showPage('page-student');
});
document.getElementById('navLeader').addEventListener('click', ()=>{buildLeaderboard();showPage('page-leader')});
document.getElementById('navCert').addEventListener('click', ()=>{buildCert();showPage('page-cert')});
document.getElementById('navAdmin').addEventListener('click', ()=>showPage('page-admin'));

/* ====== In-page controls ====== */
document.getElementById('btnToLeaderboard').addEventListener('click', ()=>{buildLeaderboard();showPage('page-leader')});
document.getElementById('btnToCert').addEventListener('click', ()=>{buildCert();showPage('page-cert')});
document.getElementById('btnBackDash').addEventListener('click', ()=>{const last=getStore('lastAttempt',null); if(last) buildStudentDashboard(last); showPage('page-student')});
document.getElementById('filterClass').addEventListener('change', buildLeaderboard);
document.getElementById('btnMyDash').addEventListener('click', ()=>{
  const last=getStore('lastAttempt',null);
  if(!last){alert('No attempt yet.');return;}
  buildStudentDashboard(last);
  showPage('page-student');
});
document.getElementById('btnSaveCert').addEventListener('click', ()=>{
  const node=document.getElementById('certBox');
  html2canvas(node).then(canvas=>{
    const a=document.createElement('a');
    a.download='certificate.png';
    a.href=canvas.toDataURL('image/png');
    a.click();
  });
});

/* ====== Auto-load leader on first open (optional) ====== */
buildLeaderboard();
</script>
</body>
</html>